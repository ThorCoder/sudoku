<!DOCTYPE html>
<html><head>
<meta charset="UTF-8">
<style>
*{margin:0 auto;padding:0;}
#box{width:500px;height:500px;font-size:20px;text-align:center;font-weight:bold;}
table table{width:100%;height:100%;font-size:12px;line-height:12px;color:#111;font-weight:normal;}
td{border:1px solid #ccc;width:11.11%;height:11.11%;}
td td{border:0 none;}
#tool{text-align:center;}
#tool button{padding:4px 6px;}
.line{position:absolute;background:#ff0000;z-index:99;left:50%;}
.liney{width:1px;height:500px;}
.line1{margin-left:-85px;}
.line2{	margin-left:80px;}
.linex{width:500px;height:1px;margin-left:-250px;}
.line3{top:169px;}
.line4{top:334px;}
</style>
</head><body onkeypress="setNo(event)">
<div class="line liney line1"></div>
<div class="line liney line2"></div>
<div class="line linex line3"></div>
<div class="line linex line4"></div>
<table id="box"></table>
<div id="tool">
	<button onclick="createBox()">重新开始</button>
	<button onclick="run()">填数完毕</button>
</div>
<script>
var nowCol=-1,nowRow=-1;//当前选中对象的行列号
var rectLen=9;//9*9
var nowColor;
var maxArr=new Array(rectLen);	//第三维存可能值(对象)，否则为确切值(数字)
var AC=0;//每次循环前置0
//初始化
function createBox(){
	var tmpMayBeObj={};
	for(var i=0;i<rectLen;i++){
		tmpMayBeObj[i+1]=true;
	}
	tmpMayBeObj=JSON.stringify(new Array(rectLen).fill(tmpMayBeObj));
	for(var i=0;i<rectLen;i++){
		maxArr[i]=JSON.parse(tmpMayBeObj);
	}
	var litLen=Math.sqrt(rectLen);
	var cont='';
	for(var i=0;i<rectLen;i++){
		cont+="<tr>";
		for(var j=0;j<rectLen;j++){
			cont+='<td id="td'+i+j+'" onclick="selNo('+i+','+j+')"><table>';
			cont+=('<tr>'+'<td></td>'.repeat(litLen)+'</tr>').repeat(litLen);
			cont+='</table></td>';
		}
		cont+="</tr>";
	}
	document.getElementById('box').innerHTML=cont;
}

//单元格点击记录坐标
function selNo(i,j){
	nowCol=i;nowRow=j;
}

//输入数字
function setNo(event){
	if(window.event){
		keynum = window.event.keyCode;
	}else if(event.which){
		keynum = event.which;
	}
	if(keynum<49 || keynum>57){
		return false;
	}
	if(nowCol>-1 && nowRow>-1){
		if(typeof maxArr[nowCol][nowRow]=='number'){
			return console.log(nowCol+'-'+nowRow+'已填入值'+maxArr[nowCol][nowRow]);
		}
		setData(nowCol,nowRow,keynum-48);
	}
}

//设置值并删除相关单元可能值
function setData(i,j,value){
	AC++;
	var tmpTdObj=document.getElementById('td'+i+j);
	tmpTdObj.innerHTML=value;
	tmpTdObj.style.color=nowColor;
	maxArr[i][j]=value;	
	runRelative(i,j,function(x,y){
		if(typeof maxArr[x][y]!='number'){
			delete maxArr[x][y][value];
		}
	});
}

//跑循环Run
function runXY(funcName){
	AC=0;
	for(var i=0;i<rectLen;i++){
		for(var j=0;j<rectLen;j++){
			if(typeof maxArr[i][j]=='number'){
				continue;
			}
			funcName(i,j);
			var mayBe=maxArr[i][j];
			if(typeof mayBe=='number'){
				setData(i,j,mayBe);
				console.log(i+"-"+j+'=>'+mayBe);
				continue;
			}
			//如果不是确切值，填入它的可能值
			miniTdList=document.getElementById('td'+i+j).querySelectorAll('td');
			for(var x=0;x<rectLen;x++){
				miniTdList[x].innerHTML=!mayBe[x+1]?'':x+1;
			}
		}
	}
	return AC;
}


//遍历目标的相关单元格
function runRelative(col,row,funcName,before,after,rTarget=-1){
	//同行 列 宫格 rTarget=0为col一样 1为row一样 2为宫格一样
	if(rTarget==-1 || rTarget==0){
		if(before) before(0);
		for(var i=0;i<rectLen;i++){
			funcName(col,i);
		}
		if(after) after(0);
	}
	if(rTarget==-1 || rTarget==1){
		if(before) before(1);
		for(var i=0;i<rectLen;i++){
			funcName(i,row);
		}
		if(after) after(1);
	}
	if(rTarget==-1 || rTarget==2){
		if(before) before(2);
		var bSqrt=Math.sqrt(rectLen);
		var bCol=col-col%bSqrt;
		var bRow=row-row%bSqrt;
		for(var i=0;i<bSqrt;i++){
			for(var j=0;j<bSqrt;j++){
				funcName(bCol+i,bRow+j);
			}
		}
		if(after) after(2);
	}
}

//根据相关单元确定值，排除本单元可能值
//唯一法
function setMayBe(col,row){
	var funcName=function(x,y){
		if(x!=col || y!=row){
			tempVar=maxArr[x][y];
			if(typeof tempVar=='number'){
				delete maxArr[col][row][tempVar];
			}
		}
	};
	runRelative(col,row,funcName);
	
	var mayBe=Object.keys(maxArr[col][row]);
	if(mayBe.length==1){
		maxArr[col][row]=mayBe[0]*1;
	}
}

//从唯一出现的可能值，确定单元值
//隐含唯一法,包含了唯一法
function tryMaybe(col,row){
		runRelative(col,row,function(x,y){
			if(x!=col || y!=row){
				var tempVar=maxArr[x][y];
				if(typeof tempVar!='number'){
					for(var key in tempVar){
						delete window.tmpObject[key];
					}
				}
			}
		},function(step){
			window.tmpObject=Object.assign({}, maxArr[col][row]);
		},function(step){
			var tempArr=Object.keys(window.tmpObject);
			if(tempArr.length==1){
				maxArr[col][row]=tempArr[0]*1;
			}
		});
	}

//二对数排除可能值
//数对、三链、...N链 5-9链，其实无实际意义
function sameMaybe(col,row){
	runRelative(col,row,function(x,y){
		if(x==col && y==row) return 0;
		var tempVar=maxArr[x][y];
		if(window.tmpObject.keys.length>rectLen/2){return;}//
		if(typeof tempVar=='number'){
			return 0;
		}
		if(Object.keys(tempVar).sort().toString()==window.tmpObject.keys.sort().toString()){
			window.tmpObject.nums++;
			window.tmpObject.sameObj[x+'-'+y]=true;
		}
	},function(step){
		window.tmpObject={
			'keys':Object.keys(maxArr[col][row]),
			'nums':1,			//记录可能值完全一样的格数
			'sameObj':{}		//记录可能值完全一样的对象
		}
		window.tmpObject.sameObj[col+"-"+row]=true;
	},function(step){
		if(window.tmpObject.nums!=window.tmpObject.keys.length){////记录可能值长度和个数一样则为对数/3链...
			return ;
		}
		if(window.tmpObject.keys.length>rectLen/2){console.log(col+'--'+row);return ;}	//
		var removeMaybe=function(targetX,targetY){
			if(typeof maxArr[targetX][targetY]=='number')return ;
			if(!window.tmpObject.sameObj[targetX+'-'+targetY]){
				for(var key in maxArr[col][row]){
					delete maxArr[targetX][targetY][key];
					var tempArr=Object.keys(maxArr[targetX][targetY]);
					if(tempArr.length==1){
						setData(targetX,targetY,tempArr[0]*1);//外部不会判断非target其他单元
					}
				}
			}
		};
		runRelative(col,row,removeMaybe,null,null,step);
	});
};



//隐含 唯一、数对、三链...N链,可再次执行sameMaybe确定确切值
function trySameMaybe(col,row){
	runRelative(col,row,function(x,y){
		var tempVar=maxArr[x][y];
		if(typeof tempVar=='number'){
			return 0;
		}
		for(var key in tempVar){
			if(!window.tmpObject[key]){
				window.tmpObject[key]=new Array();
			}
			window.tmpObject[key].push(x+'.'+y);
		}
	},function(step){
		window.tmpObject={};//key为数字-value为坐标数组
	},function(step){
		var total_num={};//key为次数-value为数字
		for(var key in window.tmpObject){
			var total=window.tmpObject[key].length;
			if(!total_num[total]) total_num[total]={};
			total_num[total][key]=true;
		}
		for(var total in total_num){
			if(total!=Object.keys(total_num[total]).length){//判断出现N次的有N个数则继续
				continue;
			}
			var sString='';
			var canRemove=true;
			for(var nums in total_num[total]){
				sString=sString==''?window.tmpObject[nums].sort().toString():sString;
				if(sString!=window.tmpObject[nums].sort().toString()){
					canRemove=false;break;
				}
			}
			if(!canRemove) continue;
			var setNo=Object.keys(total_num[total]);
			if(setNo.length==1)setNo=setNo[0]*1;
			else setNo=JSON.stringify(total_num[total]);
			for(var num in total_num[total]){
				for(var i in window.tmpObject[num]){
					var xy=window.tmpObject[num][i].split('.');
					if(typeof setNo=='number'){
						setData(xy[0],xy[1],setNo);
						continue;
					}
					maxArr[xy[0]][xy[1]]=JSON.parse(setNo);
				}
			}
		}
		
		
	});
};
function run(){
	var acRun=0;
	console.log("setMayBe");
	nowColor='green';
	while(runXY(setMayBe)>0){}
	
	nowColor='blue';
	console.log("tryMaybe");
	acRun+=runXY(tryMaybe);
	
	nowColor='#FFFF00';
	console.log("sameMaybe");
	acRun+=runXY(sameMaybe);
	while(runXY(setMayBe)>0){}
	
	nowColor='#FF0000';
	console.log("trySameMaybe");
	acRun+=runXY(trySameMaybe);
	while(runXY(setMayBe)>0){}
	nowColor='';
	if(acRun>0){
		run();
	}
}
createBox();
</script>
</body></html>
